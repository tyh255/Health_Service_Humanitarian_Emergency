head(as.data.frame(merged_data))
merged_data$Category[which(is.na(merged_data$Category))] <- 'None'



library(dplyr)
library(fixest)
library(broom)

#=========================
# Function to prepare data and estimate DiD
#=========================
run_did_analysis <- function(df, growth_threshold = 0.5, absolute_threshold = 100000) {
  # Step 1: Identify shocks
  df <- df %>%
    group_by(Country.Code, vaccine) %>%
    arrange(Year) %>%
    mutate(
      lag_total = lag(Total),
      displacement_growth = if_else(lag_total > 0, (Total - lag_total) / lag_total, NA_real_),
      shock = if_else(
        displacement_growth >= growth_threshold & Total >= absolute_threshold,
        1,
        0
      )
    ) %>%
    ungroup()
  
  # Step 2: First shock year per country
  shock_years <- df %>%
    filter(shock == 1) %>%
    group_by(Country.Code) %>%
    summarize(first_shock_year = min(Year), .groups = "drop")
  
  
  # df <- df %>% #first year only
  #   left_join(shock_years, by = "Country.Code") %>%
  #   group_by(Country.Code, vaccine) %>%
  #   arrange(Year) %>%
  #   mutate(
  #     treat = if_else(!is.na(first_shock_year), 1, 0),
  #     # post is now only TRUE in the first shock year
  #     post = if_else(Year == first_shock_year & treat == 1, 1, 0),
  #     # treatment_status is 1 only for first post-shock year
  #     treatment_status = if_else(treat == 1 & post == 1, 1, 0),
  #     GDP_per_capita_lag = lag(GDP_per_capita)
  #   ) %>%
  #   ungroup()
  
  df <- df %>% # first THREE years
    left_join(shock_years, by = "Country.Code") %>%
    group_by(Country.Code, vaccine) %>%
    arrange(Year) %>%
    mutate(
      treat = if_else(!is.na(first_shock_year), 1, 0),
      # TRUE for the first three years after shock (shock year, shock year+1, shock year+2)
      post = if_else(
        Year >= first_shock_year & Year <= first_shock_year + 2 & treat == 1,
        1, 0
      ),
      # treatment_status is also 1 for exactly those three years
      treatment_status = post,
      GDP_per_capita_lag = lag(GDP_per_capita)
    ) %>%
    ungroup()
  
  
  # Step 3b: Create conflict intensity category
  df <- df %>%
    mutate(
      conflict_cat = case_when(
        Category == "None" ~ "None",
        Category == "Low" ~ "Low",
        Category == "High" ~ "High"
      ),
      conflict_cat = factor(conflict_cat, levels = c("None", "Low", "High"))
    )

  
  did_model <- feols(
    Coverage ~ treatment_status * conflict_cat + log(GDP_per_capita_lag) | vaccine + Year,
    data = df,
    cluster = ~Country.Code
  )
  
  # Step 5: Event Study Preparation
  df_es <- df %>%
    mutate(event_time = Year - first_shock_year) %>%
    filter(event_time >= -5, event_time <= 5) %>%
    mutate(event_time_factor = factor(event_time))
  
  # Step 6: Event Study Regression (with conflict category)
  es_model <- feols(
    Coverage ~ i(event_time_factor, ref = "-1") + log(GDP_per_capita) + conflict_cat | vaccine + Year,
    data = df_es,
    cluster = ~Country.Code
  )
  
  # Step 7: Format outputs
  did_summary <- broom::tidy(did_model) %>%
    filter(term == "treatment_status") %>%
    select(term, estimate, std.error, p.value)
  
  es_summary <- broom::tidy(es_model) %>%
    filter(grepl("event_time_factor::", term)) %>%
    mutate(event_time = as.numeric(gsub("event_time_factor::", "", term))) %>%
    select(event_time, estimate, std.error, p.value)
  
  return(list(
    did_model = did_model,
    event_study_model = es_model,
    did_summary = did_summary,
    es_summary = es_summary
  ))
}



results <- run_did_analysis(
  df = merged_data,
  growth_threshold = 1.0,
  absolute_threshold = 500000
)



# Extract all relevant terms from the DiD model
did_summary_all <- broom::tidy(results$did_model) %>%
  filter(term %in% c(
    "treatment_status", 
    "conflict_catLow", 
    "conflict_catHigh",
    "treatment_status:conflict_catLow",
    "treatment_status:conflict_catHigh"
  )) %>%
  mutate(
    conf.low = estimate - 1.96 * std.error,
    conf.high = estimate + 1.96 * std.error,
    formatted = sprintf("%.2f (%.2f, %.2f)", estimate, conf.low, conf.high)
  )

# Update the stored results
results$did_summary <- did_summary_all

# View DiD result
print(results$did_summary, width = Inf)

# View pre-trend check: subset to pre-period only
results$es_summary %>% 
  filter(event_time < 0)





count_shocks_by_conflict <- function(df, growth_threshold, absolute_threshold) {
  df %>%
    group_by(Country.Code, vaccine) %>%
    arrange(Year) %>%
    mutate(
      lag_total = lag(Total),
      displacement_growth = if_else(lag_total > 0, (Total - lag_total) / lag_total, NA_real_),
      shock = if_else(displacement_growth >= growth_threshold & Total >= absolute_threshold, 1, 0)
    ) %>%
    ungroup() %>%
    
    # Step 1: identify first shock year per country
    group_by(Country.Code) %>%
    filter(shock == 1) %>%
    slice_min(Year, n = 1, with_ties = FALSE) %>%  # keep only first shock per country
    ungroup() %>%
    
    # Step 2: classify conflict category
    mutate(
      conflict_cat = case_when(
        Category == "None" ~ "None",
        Category == "Low"  ~ "Low",
        Category == "High" ~ "High",
        TRUE ~ "Unknown"
      )
    ) %>%
    
    # Step 3: count countries per conflict category
    count(conflict_cat, name = "n_countries")
}

# Example runs:
count_shocks_by_conflict(merged_data, growth_threshold = 0.5, absolute_threshold = 50000)



###Descriptive statistics
# Step 1: calculate year-on-year relative growth in displacement
displacement_data <- merged_data %>%
  group_by(Country.Code) %>%
  arrange(Year) %>%
  mutate(
    displaced = as.numeric(Total),   # replace with the actual numeric column name
    rel_growth = displaced / lag(displaced) - 1
  ) %>%
  ungroup()

# Step 2: define thresholds
thresholds <- list(
  t1 = list(rel_thresh = 0.5, abs_thresh = 50000),
  t2 = list(rel_thresh = 1.0, abs_thresh = 50000),
  t3 = list(rel_thresh = 0.5, abs_thresh = 150000),
  t4 = list(rel_thresh = 1.0, abs_thresh = 150000),
  t5 = list(rel_thresh = 0.75, abs_thresh = 250000),
  t6 = list(rel_thresh = 0.5, abs_thresh = 500000)
)

# Step 3: function to detect shocks
detect_shocks <- function(data, rel_thresh, abs_thresh, label) {
  data %>%
    filter(!is.na(rel_growth), !is.na(displaced)) %>%
    filter(rel_growth >= rel_thresh, displaced >= abs_thresh) %>%
    distinct(Country.Code, Category) %>%
    count(Category, name = "n_countries") %>%
    mutate(threshold = label)
}

# Step 4: apply across thresholds
shock_counts <- purrr::imap_dfr(
  thresholds,
  ~detect_shocks(displacement_data,
                 rel_thresh = .x$rel_thresh,
                 abs_thresh = .x$abs_thresh,
                 label = .y)
)

shock_counts


# t1 thresholds
rel_thresh <- 0.5
abs_thresh <- 50000

# Countries with shocks and missing Category, including Year
na_shock_countries <- displacement_data %>%
  filter(!is.na(rel_growth), !is.na(displaced)) %>%
  filter(rel_growth >= rel_thresh, displaced >= abs_thresh) %>%
  filter(is.na(Category)) %>%
  distinct(Country, Country.Code, Year)

na_shock_countries











