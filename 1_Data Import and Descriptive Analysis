### VACCINATION COVERAGE AND DISPLACEMENT ANALYSIS ###
# Data source: WHO/UNICEF Joint Estimates & UNHCR

library(fixest)
library(ggplot2)
library(dplyr)
library(purrr)
library(readxl)
library(tidyr)
library(states)

# Load Vaccine Coverage Data
sheets <- c("BCG", "DTP1", "DTP3", "HEPB3", "HEPBB", "HIB3", 
            "MCV1", "MCV2", "PCV3", "POL3", "RCV1", "ROTAC")

vaccine_long <- map_dfr(sheets, function(sheet) {
  read_excel("WHO UNICEF Joint Estimates.xlsx", sheet = sheet) %>%
    pivot_longer(
      cols = starts_with("20") | starts_with("19"),
      names_to = "Year",
      values_to = "Coverage"
    ) %>%
    mutate(
      Year = as.integer(Year),
      vaccine = sheet
    ) %>%
    select(
      Country = country,
      Country.Code = iso3,
      Year,
      vaccine,
      Coverage
    )
})

# Load UNHCR Displaced Persons Data
displaced <- read.csv('persons_of_concern_demographics.csv')

displaced_subset <- displaced %>%
  select(
    Year,
    Country.of.Origin.ISO,
    Female.0...4,
    Female.Total,
    Male.0...4,
    Male.Total,
    Total
  )

# Combine datasets and drop vaccines with insufficient longitudinal data
vaccine_long_merged <- vaccine_long %>%
  left_join(displaced_subset, by = c("Country.Code" = "Country.of.Origin.ISO", "Year" = "Year")) %>%
  filter(!vaccine %in% c("ROTAC", "HEPBB"))

# Incorporate World Bank GDP per capita
gdppc <- read.csv('WB GDPpC.csv')

gdppc_long <- gdppc %>%
  select(Country.Name, Country.Code, starts_with("X")) %>% 
  pivot_longer(
    cols = starts_with("X"),
    names_to = "Year",
    values_to = "GDP_per_capita"
  ) %>%
  mutate(Year = as.integer(sub("X", "", Year)))

vaccine_long_merged <- vaccine_long_merged %>%
  inner_join(gdppc_long, by = c("Country.Code", "Year"))

# Merge UCDP Conflict Data
# intensity: 1 = minor (25-999 deaths); 2 = war (1,000+ deaths)
conflict_data <- read.csv('UcdpPrioConflict_v25_2.csv')

gw_lookup <- gwstates %>%
  filter(!is.na(gwcode)) %>%
  distinct(gwcode, gwc) %>%
  rename(Country.Code = gwc, gwno = gwcode)

vaccine_long_merged <- vaccine_long_merged %>%
  left_join(gw_lookup, by = "Country.Code")

conflict_summary <- conflict_data %>%
  filter(!is.na(gwno_loc)) %>%
  group_by(gwno_loc, year) %>%
  summarise(intensity_level = max(intensity_level, na.rm = TRUE), .groups = "drop") %>%
  rename(gwno = gwno_loc)

vaccine_long_merged <- vaccine_long_merged %>%
  mutate(gwno = as.character(gwno)) %>%
  left_join(conflict_summary %>% mutate(gwno = as.character(gwno)), 
            by = c("gwno", "Year" = "year"))

# Merge Natural Disaster Data (EM-DAT)
disaster_data <- read.csv('emdat_2025_natural_disasters.csv') %>%
  filter(Disaster.Type != 'Epidemic')

fatality_summary <- disaster_data %>%
  group_by(ISO, Start.Year) %>%
  summarise(
    sum_fatality = sum(Total.Deaths, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(Category = case_when(
    sum_fatality < 25 | is.na(sum_fatality) ~ "None",
    sum_fatality >= 25 & sum_fatality < 1000 ~ "Low",
    sum_fatality >= 1000 ~ "High"
  ))

merged_data <- vaccine_long_merged %>%
  left_join(
    fatality_summary %>% select(ISO, Start.Year, sum_fatality, Category),
    by = c("Country.Code" = "ISO", "Year" = "Start.Year")
  ) %>%
  group_by(Country.Code) %>%
  arrange(Year, .by_group = TRUE) %>%
  fill(sum_fatality, Category, .direction = "down") %>%
  ungroup()

### DESCRIPTIVE PLOTS ###

vaccine_long_merged <- vaccine_long_merged %>%
  mutate(
    displacement_group = ntile(Total, 5),
    displacement_group = factor(
      displacement_group,
      levels = 1:5,
      labels = c("Lowest", "Low-mid", "Mid", "High-mid", "Highest")
    )
  )

ggplot(
  vaccine_long_merged %>% filter(!is.na(Coverage), !is.na(displacement_group)),
  aes(x = Year, y = Coverage, color = displacement_group, group = displacement_group)
) +
  stat_summary(fun = mean, geom = "line", size = 1.2, alpha = 0.75) +
  labs(title = "Vaccination Coverage by Displacement Burden", x = "Year", y = "Avg Coverage (%)") +
  theme_minimal()

### REGRESSION ANALYSIS ###

# Fixed Effects Models
model <- feols(Coverage ~ displacement_group + log(GDP_per_capita) | vaccine + Year, 
               data = vaccine_long_merged)

# Conflict-specific analysis
vaccination_descriptive <- vaccine_long_merged %>%
  mutate(intensity_level = case_when(
    is.na(intensity_level) ~ '1.none',
    intensity_level == 1 ~ '2.minor',
    intensity_level == 2 ~ '3.war'
  ))

model_conflict <- feols(Coverage ~ as.factor(intensity_level) + log(GDP_per_capita) | vaccine + Year, 
                        data = vaccination_descriptive)

### DIFFERENCE-IN-DIFFERENCES FUNCTION ###

run_did_analysis <- function(df, growth_threshold = 1.0, absolute_threshold = 500000) {
  
  # Identify first shock year
  df_shocks <- df %>%
    group_by(Country.Code, vaccine) %>%
    arrange(Year) %>%
    mutate(
      lag_total = lag(Total),
      displacement_growth = (Total - lag_total) / lag_total,
      shock = if_else(displacement_growth >= growth_threshold & Total >= absolute_threshold, 1, 0)
    ) %>%
    ungroup()

  shock_years <- df_shocks %>%
    filter(shock == 1) %>%
    group_by(Country.Code) %>%
    summarize(first_shock_year = min(Year), .groups = "drop")

  # Create Treatment/Post indicators
  df_final <- df %>%
    left_join(shock_years, by = "Country.Code") %>%
    mutate(
      treat = if_else(!is.na(first_shock_year), 1, 0),
      treatment_status = if_else(Year == first_shock_year & treat == 1, 1, 0),
      conflict_cat = factor(case_when(
        is.na(intensity_level) ~ "None",
        intensity_level == 1 ~ "Low-level",
        intensity_level >= 2 ~ "War"
      ), levels = c("None", "Low-level", "War"))
    )

  # Interaction model
  did_model <- feols(
    Coverage ~ treatment_status * conflict_cat + log(GDP_per_capita) | vaccine + Year,
    data = df_final, cluster = ~Country.Code
  )
  
  # Event Study setup
  df_es <- df_final %>%
    mutate(event_time = Year - first_shock_year) %>%
    filter(event_time >= -5, event_time <= 5)
  
  es_model <- feols(
    Coverage ~ i(factor(event_time), ref = "-1") + log(GDP_per_capita) + conflict_cat | vaccine + Year,
    data = df_es, cluster = ~Country.Code
  )

  return(list(did_model = did_model, es_model = es_model))
}

# Run for specific threshold
results <- run_did_analysis(vaccine_long_merged, growth_threshold = 1.0, absolute_threshold = 500000)
summary(results$did_model)
